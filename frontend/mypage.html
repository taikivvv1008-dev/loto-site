<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MYページ | LotoLogic</title>
  <link rel="stylesheet" href="./css/style.css" />
</head>
<body>

<header class="header">
  <div class="container header__inner">
    <a class="logo" href="home.html">
      <img class="logo__img logo__img--header" src="./assets/logo.webp" alt="LotoLogic">
    </a>

    <nav class="nav">
      <a class="btn btn--ghost" href="mypage.html">MYページ</a>
    </nav>
  </div>
</header>

<!-- サブナビ（タブ） -->
<div class="subnav">
  <div class="container subnav__inner">
    <a class="tab" href="home.html">ホーム</a>
    <a class="tab" href="loto6-logic.html">ロト6ロジック予想</a>
    <a class="tab" href="loto7-logic.html">ロト7ロジック予想</a>
    <a class="tab" href="loto6-fortune.html">ロト6占い予想</a>
    <a class="tab" href="loto7-fortune.html">ロト7占い予想</a>
    <a class="tab" href="results.html">当選結果</a>
    <a class="tab is-active" href="mypage.html">MYページ</a>
  </div>
</div>

<main>
  <section class="section">
    <div class="container">

      <h1 class="dash-title" style="margin:0 0 8px;">MYページ</h1>
      <p class="dash-sub" id="mypageSub" style="margin:0 0 16px;">
        アカウント状況と課金状態を確認できます。
      </p>

      <!-- ローディング -->
      <div id="mypageLoading" class="card" style="padding:24px;text-align:center;">
        <p style="font-weight:700;">読み込み中…</p>
      </div>

      <!-- 実コンテンツ (初期非表示) -->
      <div id="mypageContent" style="display:none;">
        <div class="dash-grid dash-grid--single">

          <!-- アカウント -->
          <section class="panel">
            <div class="panel__head">
              <h2 class="panel__title">アカウント</h2>
            </div>

            <p class="muted-line">
              メール：<strong id="userEmail">-</strong><br>
              登録日：<strong id="userCreatedAt">-</strong>
            </p>

            <div class="draw-card__actions" style="margin-top:12px;">
              <button class="btn btn--outline" id="logoutBtn">ログアウト</button>
            </div>
          </section>

          <!-- 課金管理 -->
          <section class="panel panel--featured" id="billingPanel">
            <div class="panel__head">
              <h2 class="panel__title">課金管理</h2>
            </div>

            <!-- プレミアム会員の場合 -->
            <div id="billingActive" style="display:none;">
              <p class="muted-line">
                ステータス：<strong style="color:#166534;">有料プラン（課金中）</strong>
              </p>

              <div class="draw-card__actions" style="margin-top:12px;">
                <button class="btn btn--primary" id="portalBtn">Stripe管理画面を開く</button>
              </div>
              <p class="mini-note">※ 領収書の確認・プラン変更・解約はStripe管理画面で行えます。</p>
            </div>

            <!-- 無料会員の場合 -->
            <div id="billingInactive" style="display:none;">
              <p class="muted-line">
                ステータス：<strong style="color:#b91c1c;">無料（未課金）</strong>
              </p>
              <p class="muted-line" style="margin-top:8px;">
                予想番号を閲覧するには有料プラン（月額550円・税込）への登録が必要です。
              </p>

              <div class="draw-card__actions" style="margin-top:12px;">
                <button class="btn btn--primary" id="upgradeBtn">有料プランに登録する</button>
              </div>
            </div>
          </section>

        </div>
      </div>

    </div>
  </section>
</main>

<footer class="footer">
  <div class="container footer__inner">
    <p class="footer__copy">Copyright &copy; 2023 - LotoLogic</p>
    <div class="footer__links">
      <a href="terms.html">利用規約</a>
      <a href="privacy.html">プライバシー</a>
      <a href="tokusho.html">特商法</a>
    </div>
  </div>
</footer>

<script>window.LOTO_ENGINE_BASE="";</script>
<script src="./js/auth.js"></script>
<script>
(async function() {
  const premiumOk = await LotoAuth.requirePremium();
  if (!premiumOk) return;

  const API = window.LOTO_ENGINE_BASE || "";

  async function loadMypage() {
    try {
      const res = await LotoAuth.fetchWithAuth(API + "/auth/me");
      if (!res.ok) throw new Error("Failed to fetch user info");
      const user = await res.json();

      // Update cached user
      LotoAuth.setUser(user);

      // Populate
      document.getElementById("userEmail").textContent = user.email || "-";
      document.getElementById("userCreatedAt").textContent = user.created_at ? user.created_at.split("T")[0].split(" ")[0] : "-";

      if (user.is_premium) {
        document.getElementById("billingActive").style.display = "block";
        document.getElementById("billingInactive").style.display = "none";
      } else {
        document.getElementById("billingActive").style.display = "none";
        document.getElementById("billingInactive").style.display = "block";
      }

      document.getElementById("mypageLoading").style.display = "none";
      document.getElementById("mypageContent").style.display = "block";
    } catch (e) {
      console.error(e);
      document.getElementById("mypageLoading").innerHTML = '<p style="font-weight:700;color:#b91c1c;">読み込みに失敗しました。</p>';
    }
  }

  loadMypage();

  // Logout
  document.getElementById("logoutBtn").addEventListener("click", () => {
    LotoAuth.logout();
  });

  // Stripe Portal
  document.getElementById("portalBtn").addEventListener("click", async () => {
    const btn = document.getElementById("portalBtn");
    btn.disabled = true;
    btn.textContent = "読み込み中…";
    try {
      const res = await LotoAuth.fetchWithAuth(API + "/billing/create-portal-session", { method: "POST" });
      const data = await res.json();
      if (data.portal_url) {
        window.location.href = data.portal_url;
      } else {
        alert("ポータルの取得に失敗しました");
        btn.disabled = false;
        btn.textContent = "Stripe管理画面を開く";
      }
    } catch (e) {
      alert("通信エラーが発生しました");
      btn.disabled = false;
      btn.textContent = "Stripe管理画面を開く";
    }
  });

  // Upgrade
  document.getElementById("upgradeBtn").addEventListener("click", async () => {
    const btn = document.getElementById("upgradeBtn");
    btn.disabled = true;
    btn.textContent = "読み込み中…";
    try {
      const res = await LotoAuth.fetchWithAuth(API + "/billing/create-checkout-session", { method: "POST" });
      const data = await res.json();
      if (data.checkout_url) {
        window.location.href = data.checkout_url;
      } else {
        alert("決済セッションの作成に失敗しました");
        btn.disabled = false;
        btn.textContent = "有料プランに登録する";
      }
    } catch (e) {
      alert("通信エラーが発生しました");
      btn.disabled = false;
      btn.textContent = "有料プランに登録する";
    }
  });
})();
</script>

</body>
</html>
